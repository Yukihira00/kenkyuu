# llm_analyzer.py
import os
import json
import re
import google.generativeai as genai
from dotenv import load_dotenv
from sentence_transformers import SentenceTransformer

load_dotenv(encoding='utf-8')
API_KEY = os.getenv('GEMINI_API_KEY')

genai.configure(api_key=API_KEY)
model = genai.GenerativeModel('gemini-2.5-flash')
embedding_model = SentenceTransformer('all-mpnet-base-v2')

# --- カテゴリ定義 (ユーザー提供の資料に基づいて変更) ---

# 1. content_category: Yahoo!知恵袋のカテゴリをベース
CONTENT_CATEGORIES = {
    "エンターテインメントと趣味": [
        "芸能人", "話題の人物", "あの人は今", "俳優、女優", "ミュージシャン", "女性アイドル", "男性アイドル", "グラビアアイドル", "お笑い芸人",
        "テレビ、ラジオ", "CM", "ドラマ", "海外ドラマ", "アジア・韓国ドラマ", "特撮", "バラエティ、お笑い", "教養、ドキュメンタリー", "情報番組、ワイドショー", "アナウンサー", "ラジオ",
        "音楽", "邦楽", "洋楽", "K-POP、アジア", "クラシック", "ジャズ", "楽器全般", "ギター、ベース", "ピアノ、キーボード", "ドラム、打楽器", "バンド", "合唱、声楽", "吹奏楽", "管弦楽、オーケストラ", "ライブ、コンサート", "作詞、作曲", "DTM", "カラオケ",
        "映画", "外国映画", "日本映画",
        "演劇、ミュージカル", "宝塚", "劇団四季",
        "アニメ、コミック", "アニメ", "声優", "コミック", "同人誌、コミケ", "コスプレ",
        "ゲーム", "Wii", "WiiU", "プレイステーション3", "プレイステーション4", "Xbox", "テレビゲーム全般", "ニンテンドーDS", "ニンテンドー3DS", "プレイステーション・ポータブル", "プレイステーションVita", "携帯型ゲーム全般", "遊戯王", "ヴァンガード", "バトルスピリッツ", "ファイナルファンタジー", "ドラゴンクエスト", "ポケットモンスター", "モンスターハンター", "ゲームセンター", "リズム、音楽ゲーム", "トレーディングカード", "将棋、囲碁", "麻雀",
        "オンラインゲーム", "マインクラフト", "艦隊これくしょん", "刀剣乱舞",
        "趣味", "ダンス", "バレエ", "絵画", "手芸", "工芸", "アマチュア無線", "ミリタリー", "サバイバルゲーム", "鉄道ファン",
        "おもちゃ", "模型、プラモデル、ラジコン", "フィルムカメラ", "マジック",
        "本、雑誌", "話題の本", "読書", "ライトノベル", "小説", "ビジネス書", "雑誌", "電子書籍",
        "占い、超常現象", "占い", "超常現象、オカルト",
        "懸賞、くじ",
        "伝統文化、伝統芸能", "茶道", "歌舞伎", "落語、寄席"
    ],
    "暮らしと生活ガイド": [
        "料理、レシピ", "レシピ", "料理、食材", "菓子、スイーツ", "お酒、ドリンク", "飲食店", "ファミリーレストラン", "ファーストフード", "カフェ、喫茶",
        "家事", "掃除", "洗濯、クリーニング",
        "住宅", "家具、インテリア", "収納", "DIY", "不動産", "土地", "注文住宅", "住宅ローン", "耐震", "リフォーム", "新築一戸建て", "中古一戸建て", "新築マンション", "中古マンション", "賃貸物件", "引越し", "害虫、ねずみ",
        "日用品、生活雑貨", "キッチン用品", "文房具", "アロマ",
        "ショッピング", "これ、探してます", "ショッピングモール", "スーパーマーケット", "コンビニ", "ドン・キホーテ", "100円ショップ", "コストコ", "IKEA", "無印良品", "ニトリ", "ニッセン",
        "法律、消費者問題", "法律相談", "消費者問題", "交通事故",
        "公共施設、役所", "美術館、博物館", "図書館", "役所、手続き",
        "郵便、宅配",
        "ボランティア、環境問題、国際協力", "ボランティア", "募金、寄付", "地球温暖化", "エコ活動、エコライフ",
        "福祉、介護",
        "ペット", "イヌ", "ネコ", "げっ歯類、ウサギ", "鳥類", "爬虫類、両生類", "アクアリウム",
        "園芸、ガーデニング", "家庭菜園", "観葉植物", "バラ",
        "海外生活"
    ],
    "健康、美容とファッション": [
        "健康、病気、病院", "病院、検査", "病気、症状", "インフルエンザ", "目の病気", "耳の病気", "皮膚の病気、アトピー", "花粉症、アレルギー", "デンタルケア", "コンタクトレンズ、視力矯正", "ニキビケア", "水虫", "薄毛、抜け毛", "生理", "女性の病気", "男性の病気", "性病、性感染症",
        "ダイエット、フィットネス", "ダイエット", "ジョギング", "ウォーキング", "マッサージ、整体", "ヨガ、ピラティス",
        "コスメ、美容", "メイク、コスメ", "スキンケア", "香水", "エステ、脱毛", "ヘアケア", "ヘアスタイル", "ネイルケア", "美容整形",
        "ファッション", "メンズ全般", "メンズシューズ", "メンズバッグ、財布、小物類", "メンズ腕時計、アクセサリー", "メンズスーツ", "レディース全般", "レディースシューズ", "レディースバッグ、財布、小物類", "レディース腕時計、アクセサリー", "ピアス", "メガネ、サングラス", "着物、和服", "古着、リメイク",
        "メンタルヘルス", "うつ病", "ストレス", "カウンセリング、治療", "発達障害",
        "性の悩み、相談"
    ],
    "マナー、冠婚葬祭": [
        "冠婚葬祭", "結婚", "葬儀",
        "マナー", "あいさつ、てがみ、文例", "食事のマナー", "喫煙マナー", "携帯電話のマナー", "交通、運転マナー", "ビジネスマナー",
        "年中行事",
        "クリスマス",
        "正月、年末年始",
        "宗教"
    ],
    "生き方と恋愛、人間関係の悩み": [
        "恋愛相談、人間関係の悩み", "恋愛相談", "友人関係の悩み", "家族関係の悩み", "職場の悩み", "ご近所の悩み", "学校の悩み",
        "生き方、人生相談", "将来の夢", "一人暮らし、シングルライフ", "シニアライフ、シルバーライフ", "移住、田舎暮らし"
    ],
    "子育てと学校": [
        "子育て、出産", "子育ての悩み", "妊娠、出産", "不妊", "避妊", "母子家庭、父子家庭", "子どもの病気とトラブル", "子どもとインターネット",
        "幼児教育、幼稚園、保育園",
        "小・中学校、高校", "小学校", "中学校", "高校",
        "大学、短大、大学院", "大学", "大学院",
        "留学、ホームステイ",
        "受験、進学", "大学受験", "高校受験", "中学受験", "幼稚園・小学受験", "予備校、進学塾",
        "不登校"
    ],
    "インターネット、通信": [
        "携帯電話キャリア", "au", "ソフトバンク", "Y!mobile", "ドコモ",
        "ガラケーサービス",
        "インターネット接続",
        "インターネットサービス", "サービス、探しています", "ウイルス対策、セキュリティ対策", "ホームページ作成", "メール",
        "ブラウザ", "Internet Explorer", "Google Chrome", "Firefox", "Safari",
        "スマホアプリ", "写真、ビデオ", "ミュージック", "パズルゲーム", "カードゲーム", "ロールプレイングゲーム", "シミュレーションゲーム",
        "コミュニケーションサービス", "Skype", "LINE", "カカオトーク", "Facebook", "mixi", "X（旧Twitter）", "Instagram", "Tumblr",
        "ブログサービス", "アメーバブログ", "FC2ブログ", "ライブドアブログ", "Yahoo!ブログ",
        "動画サービス", "YouTube", "ニコニコ動画", "GYAO!", "Hulu", "ツイキャス", "Ustream",
        "クラウドサービス", "iCloud", "Evernote", "Dropbox", "Google ドライブ",
        "画像、写真共有", "Google フォト", "pixiv",
        "インターネットショッピング", "Amazon", "楽天市場",
        "オークション、フリマサービス", "楽天オークション", "モバオク", "メルカリ", "Fril"
    ],
    "スマートデバイス、PC、家電": [
        "スマートデバイス、ガラケー", "スマートフォン", "iPhone", "Android", "スマートフォンアクセサリー", "タブレット端末", "ウェアラブル端末", "ガラケー", "格安スマホ", "SIMフリー端末",
        "OS", "Windows 7", "Windows 8", "Windows 10", "Windows Vista", "Windows XP", "Windows 全般", "Macintosh（Mac)", "Unix系",
        "パソコン",
        "周辺機器", "プリンター", "3Dプリンター",
        "Office系ソフトウェア", "Word", "Excel", "PowerPoint",
        "ソフトウェア", "画像処理、制作", "Photoshop", "Illustrator", "動画、映像", "音声、音楽", "CAD", "ファイル共有、P2P", "圧縮、解凍",
        "家電、AV機器", "掃除機、洗濯機", "冷蔵庫、キッチン家電", "エアコン、空調家電", "ポータブル音楽プレーヤー", "オーディオ", "テレビ、DVD、ホームシアター", "ビデオカメラ", "電池",
        "デジタルカメラ", "コンパクトデジタルカメラ", "デジタル一眼レフ",
        "固定電話"
    ],
    "コンピュータテクノロジー": [
        "OS", "Linux系", "Windows系",
        "プログラミング", "C言語関連", "Java", "PHP", "Ruby", "JavaScript", "HTML、CSS", "Visual Basic",
        "アプリ開発", "Android開発", "iOS開発",
        "データベース", "Oracle", "SQL Server", "PostgreSQL", "MySQL", "Microsoft Access",
        "ネットワーク技術", "サーバ管理、保守", "通信プロトコル", "LAN",
        "セキュリティ", "暗号と認証", "ネットワークセキュリティ"
    ],
    "教養と学問、サイエンス": [
        "言葉、語学", "日本語", "英語", "韓国・朝鮮語", "中国語", "フランス語", "ドイツ語", "スペイン語", "イタリア語", "ロシア語",
        "生物、動物、植物", "ヒト", "動物", "水の生物", "昆虫", "植物",
        "歴史", "日本史", "世界史", "中国史",
        "芸術、文学、哲学", "文学、古典", "哲学、倫理", "心理学", "美術、芸術", "建築",
        "サイエンス", "化学", "工学", "農学、バイオテクノロジー", "物理学", "地学",
        "数学", "算数", "中学数学", "高校数学", "大学数学",
        "天気、天文、宇宙", "気象、天気", "天文、宇宙",
        "宿題",
        "一般教養"
    ],
    "ビジネス、経済とお金": [
        "企業と経営", "会計、経理、財務", "会社情報、業界市場リサーチ", "起業", "企業法務、知的財産", "インターネットビジネス、SOHO",
        "株と経済", "株式", "経済、景気", "資産運用、投資信託、NISA", "外国為替、FX",
        "税金、年金", "税金", "年金",
        "保険", "生命保険", "社会保険", "国民健康保険", "自動車保険", "学資保険",
        "家計、貯金", "家計、節約", "貯金", "ローン", "ネットバンキング",
        "決済、ポイントサービス", "電子マネー、電子決済", "Suica", "ICOCA", "PASMO", "WAON", "nanaco", "Edy", "Tカード", "クレジットカード", "デビットカード"
    ],
    "ニュース、政治、国際情勢": [
        "政治、社会問題", "マイナンバー",
        "国際情勢",
        "ニュース、事件", "事件、事故", "流行、話題のことば",
        "災害", "地震", "台風", "火山", "原子力災害", "防災", "避難所", "仮設住宅", "災害ボランティア",
        "エネルギー、資源", "石油、天然ガス", "自然エネルギー", "原子力", "エネルギー政策"
    ],
    "職業とキャリア": [
        "職業", "この仕事教えて",
        "就職、転職", "就職活動", "退職", "転職", "公務員試験",
        "労働問題、働き方", "単身赴任、転勤", "労働問題", "労働条件、給与、残業", "失業、リストラ", "仕事効率化、ノウハウ",
        "派遣、アルバイト、パート", "アルバイト、フリーター", "派遣", "パート",
        "資格、習い事", "資格", "簿記", "専門学校、職業訓練", "習い事"
    ],
    "スポーツ、アウトドア、車": [
        "自動車", "新車", "中古車", "カスタマイズ", "車検、メンテナンス", "運転免許",
        "バイク", "新車", "中古車", "カスタマイズ", "車検、メンテナンス", "運転免許",
        "スポーツ", "プロ野球", "MLB", "野球全般", "高校野球", "ソフトボール", "ゴルフ", "サッカー", "海外サッカー", "FIFAワールドカップ", "ラグビー、アメフト", "テニス", "ソフトテニス", "卓球", "バドミントン", "バレーボール", "バスケットボール", "ハンドボール", "ボウリング", "大相撲", "総合格闘技、K-1", "プロレス", "ボクシング", "格闘技、武術全般", "水泳", "ダイビング", "サーフィン", "マラソン、陸上競技", "体操", "スキー", "スノーボード", "スケート、アイスホッケー", "フィギュアスケート", "モータスポーツ", "トレーニング", "オリンピック", "パラリンピック",
        "自転車、サイクリング",
        "アウトドア", "釣り", "キャンプ、バーベキュー", "登山", "ヨット、ボート"
    ],
    "地域、旅行、お出かけ": [
        "国内", "ここ、探してます", "観光地、行楽地", "テーマパーク", "動物園、水族館", "ホテル、旅館", "温泉", "季節のおでかけ", "イベント、フェス", "祭り、花火大会", "博覧会", "おでかけグルメ", "おみやげ、ご当地名物",
        "交通、地図", "鉄道、列車、駅", "飛行機、空港", "フェリー、港", "車、高速道路", "バス、タクシー",
        "海外", "パスポート", "ビザ", "ホテル", "観光"
    ],
    "その他": [
        "アダルト",
        "ギャンブル", "競馬", "競輪", "ボートレース（競艇）", "パチンコ", "スロット",
        "○○好き（男子）", "メガネ男子", "スーツ、制服男子", "筋肉フェチ", "血管フェチ", "手、指フェチ",
        "○○好き（女子）", "メガネ女子", "スーツ、制服女子", "うなじフェチ", "二の腕フェチ", "太もも～足首フェチ", "好きな髪型",
        "おしゃべり、雑談",
        "ユーモア、ネタ", "アスキーアート",
        "大喜利",
        "クイズ",
        "雑談",
        "投稿練習"
    ]
}


# 2. expression_category: (プルチックの感情の輪に基づく、純粋な感情のみ - 重複なし24要素)
EXPRESSION_CATEGORIES = [
    # 8つの基本感情（1列目）
    "喜び", "信頼", "恐れ", "驚き", "悲しみ", "嫌悪", "怒り", "期待",
    # 8つの強い感情（2列目）
    "恍惚", "感嘆", "恐怖", "驚嘆", "悲痛", "憎悪", "激怒", "警戒",
    # 8つの弱い感情（3列目）
    "平穏", "容認", "心配", "動揺", "憂い", "退屈", "煩さ", "興味"
]


# 3. style_stance_category: (文体や書き手のスタンスに関するもののみ)
STYLE_STANCE_CATEGORIES = [
    # 1. 優位・指導的なスタンス
    "上から目線", "教訓的・啓発的", "皮肉・当てこすり", "恩着せがましい",
    # 2. 劣位・受動的なスタンス
    "謙遜・へりくだった", "卑屈・自己卑下",
    # 3. 水平・中立的なスタンス
    "丁寧・中立", "客観的・分析的", "冷淡・突き放す",
    "独り言・独白", 
    # 4. 協調・共感的なスタンス
    "共感的・寄り添う", "親しみを込めた", "激励・応援",
    "ユーモア・ネタ", 
    "情熱・熱狂",    
    # 6. 対立・攻撃的なスタンス
    "挑発的・攻撃的", "無関心・他人行儀",
]


flat_content_categories = [item for sublist in CONTENT_CATEGORIES.values() for item in sublist]

def analyze_posts_batch(texts: list[str]):
    error_result = {
        "content_category": "分析失敗", "expression_category": "分析失敗",
        "style_stance_category": "分析失敗", "embedding": None
    }
    if not API_KEY:
        print("エラー: GEMINI_API_KEYが設定されていません。")
        return [error_result] * len(texts)

    try:
        # all-mpnet-base-v2 の次元数は 768 です。
        embeddings = embedding_model.encode(texts).tolist()
    except Exception as e:
        print(f"テキストのベクトル化中にエラーが発生しました: {e}")
        embeddings = [None] * len(texts)

    if not texts:
        return []

    # インデントエラー回避のため、ここで改行とバックスラッシュをエスケープ
    formatted_texts = "\\n".join(f"投稿{i+1}:\\n---\\n{text}\\n---" for i, text in enumerate(texts))

    # ▼▼▼【変更】プロンプトに各カテゴリの役割と排他性を強調（インデント修正済み） ▼▼▼
    prompt = f"""
以下のSNS投稿リスト（{len(texts)}件）を分析し、3つの軸で最も適切なカテゴリを1つずつ選択してください。
回答は、JSONオブジェクトのリスト形式で、投稿の順番通りに出力してください。

# 分析の軸と目的:
1. content_category: 投稿の主要な内容（話題）。
2. expression_category: 投稿全体の**純粋な感情的な表現**（喜び、悲しみなど）。**文体やスタンスは選択しないでください。**
3. style_stance_category: 投稿の**文体や書き手のスタンス**（丁寧さ、攻撃性、独白など）。**感情を直接表す言葉は選択しないでください。**

# カテゴリリスト (必ずこの中から選択):
- "content_category": {flat_content_categories}
- "expression_category": {EXPRESSION_CATEGORIES}
- "style_stance_category": {STYLE_STANCE_CATEGORIES}

# 分類例:
- 投稿例: 「新しいプロジェクトが無事完了！チームのみんな、本当にお疲れ様でした！最高のメンバーに感謝！」
  - "content_category": "職業"
  - "expression_category": "喜び"
  - "style_stance_category": "親しみを込めた"
- 投稿例: 「今日のランチはパスタ。まあまあ美味しかった。」
  - "content_category": "料理、レシピ"
  - "expression_category": "平穏"
  - "style_stance_category": "丁寧・中立"
- 投稿例: 「なんでいつもこうなるの？本当にありえない。もう我慢の限界。」
  - "content_category": "恋愛相談、人間関係の悩み"
  - "expression_category": "激怒"
  - "style_stance_category": "挑発的・攻撃的"
- 投稿例: 「お前バカだなｗそんなことも知らんのか」
  - "content_category": "雑談"
  - "expression_category": "嫌悪"
  - "style_stance_category": "上から目線"
- 投稿例: 「お腹すいたな…。今日の夕飯何にしよう。」
  - "content_category": "雑談"
  - "expression_category": "平穏"
  - "style_stance_category": "独り言・独白"
- 投稿例: 「財布忘れて家出たことに駅で気づいた時の絶望感よ。サザエさんか私は。」
  - "content_category": "ユーモア、ネタ"
  - "expression_category": "悲しみ"
  - "style_stance_category": "ユーモア・ネタ"
- 投稿例: 「待って無理しんどい！！！推しのビジュが良すぎて爆発した†┏┛墓┗┓†」
  - "content_category": "アニメ、コミック"
  - "expression_category": "恍惚"
  - "style_stance_category": "情熱・熱狂"

# 制約（絶対に守ってください）:
- "expression_category"には、"style_stance_category"にリストされているカテゴリ（「独り言・独白」「ユーモア・ネタ」「情熱・熱狂」「丁寧・中立」など）は**絶対に選択しないでください**。
- "style_stance_category"には、プルチックの感情の輪に基づく純粋な感情（「喜び」「悲しみ」「怒り」など）は**絶対に選択しないでください**。
- 必ず投稿{len(texts)}件分、つまり{len(texts)}個のJSONオブジェクトをリストに入れて返してください。
- 分析が困難な場合でも、カテゴリを「その他」や「その他・分類不能」として必ずオブジェクトを作成してください。
- 回答はJSONリストのみとし、説明文は一切含めないでください。
- 各JSONオブジェクトには3つのキー（content_category, expression_category, style_stance_category）を必ず含めてください。
- **最終出力の前に、生成したJSONオブジェクトの数が{len(texts)}個であることを必ず確認してください。数が違う場合は、リストを修正して{len(texts)}個にしてください。**

# 投稿リスト:
{formatted_texts}

# 出力形式 (JSONリスト):
[
  {{"content_category": "...", "expression_category": "...", "style_stance_category": "..."}},
  ...
]
"""
    
    try:
        response = model.generate_content(prompt)
        match = re.search(r'```json\s*(\[.*\])\s*```|(\[.*\])', response.text, re.DOTALL)
        if not match:
            print("エラー: LLM応答からJSONリストが見つかりません。")
            print(f"--- LLMからの応答 ---\n{response.text}\n--------------------")
            return [error_result] * len(texts)

        json_text = match.group(1) or match.group(2)
        analysis_results_json = json.loads(json_text)

        if isinstance(analysis_results_json, list) and len(analysis_results_json) == len(texts):
            full_results = []
            for i, result in enumerate(analysis_results_json):
                final_result = {
                    "content_category": result.get("content_category", "その他"),
                    "expression_category": result.get("expression_category", "その他・分類不能"),
                    "style_stance_category": result.get("style_stance_category", "その他"),
                    "embedding": embeddings[i]
                }
                full_results.append(final_result)
            return full_results
        else:
            print(f"エラー: LLMからの結果件数が一致しません。(期待: {len(texts)}, 実際: {len(analysis_results_json)})")
            print(f"--- LLMからの応答 ---\n{response.text}\n--------------------")
            return [error_result] * len(texts)

    except json.JSONDecodeError as e:
        print(f"JSONの解析に失敗しました: {e}")
        print(f"--- LLMからの応答 ---\n{response.text}\n--------------------")
        return [error_result] * len(texts)
    except Exception as e:
        print(f"LLMでの分析中に予期せぬエラーが発生しました: {e}")
        if 'response' in locals() and hasattr(response, 'text'):
            print(f"--- LLMからの応答 ---\n{response.text}\n--------------------")
        return [error_result] * len(texts)